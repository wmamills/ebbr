
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>4. Firmware Storage &#8212; Embedded Base Boot Requirements (EBBR) Specification v2.0.0-24-gccd0c3e documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="5. Bibliography" href="references.html" />
    <link rel="prev" title="3. Privileged or Secure Firmware" href="chapter3-secureworld.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Embedded Base Boot Requirements (EBBR) Specification</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="chapter1-about.html">1. About This Document</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter2-uefi.html">2. UEFI</a></li>
<li class="toctree-l1"><a class="reference internal" href="chapter3-secureworld.html">3. Privileged or Secure Firmware</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">4. Firmware Storage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#partitioning-of-shared-storage">4.1. Partitioning of Shared Storage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gpt-partitioning">4.1.1. GPT partitioning</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mbr-partitioning">4.1.1.1. MBR partitioning</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#firmware-partition-filesystem">4.2. Firmware Partition Filesystem</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#fixed-shared-storage">4.2.1. Fixed Shared Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#removable-shared-storage">4.2.2. Removable Shared Storage</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="references.html">5. Bibliography</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="chapter3-secureworld.html" title="previous chapter">3. Privileged or Secure Firmware</a></li>
      <li>Next: <a href="references.html" title="next chapter">5. Bibliography</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="firmware-storage">
<h1>4. Firmware Storage<a class="headerlink" href="#firmware-storage" title="Permalink to this headline">¶</a></h1>
<p>In general, EBBR compliant platforms should use dedicated storage for boot
firmware images and data,
independent of the storage used for OS partitions and the EFI System Partition
(ESP).
This could be a physically separate device (e.g. SPI flash),
or a dedicated logical unit (LU) within a device
(e.g. eMMC boot partition, <a class="footnote-reference" href="#emmcbootpartition" id="id1">[1]</a>
or UFS boot LU <a class="footnote-reference" href="#logicalunitnote" id="id2">[2]</a>).</p>
<p>However, many embedded systems have size, cost, or implementation
constraints that make separate firmware storage unfeasible.
On such systems, firmware and the OS reside in the same storage device.
Care must be taken to ensure firmware kept in normal storage does not
conflict with normal usage of the media by an OS.</p>
<ul class="simple">
<li>Firmware must be stored on the media in a way that does not conflict
with normal partitioning and usage by the operating system.</li>
<li>Normal operation of the OS must not interfere with firmware files.</li>
<li>Firmware needs a method to modify variable storage at runtime while the
OS controls access to the device. <a class="footnote-reference" href="#luvariables" id="id3">[3]</a></li>
</ul>
<table class="docutils footnote" frame="void" id="emmcbootpartition" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Watch out for the ambiguity of the word ‘partition’.
In most of this document, a ‘partition’ is a contiguous region of a block
device as described by a GPT or MBR partition table,
but eMMC devices also provide a dedicated ‘boot partition’ that is addressed
separately from the main storage region, and does not appear in the
partition table.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="logicalunitnote" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>For the purposes of this document, logical units are
treated as independent storage devices, each with their own GPT or MBR
partition table.
A platform that uses one LU for firmware, and another LU for OS partitions
and the ESP is considered to be using dedicated firmware storage.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="luvariables" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td>Runtime access to firmware data may still be an issue when
firmware is stored in a dedicated LU, simply because the OS remains in
control of the storage device command stream. If firmware doesn’t have
a dedicated channel to the storage device, then the OS must proxy all
runtime storage IO.</td></tr>
</tbody>
</table>
<div class="section" id="partitioning-of-shared-storage">
<h2>4.1. Partitioning of Shared Storage<a class="headerlink" href="#partitioning-of-shared-storage" title="Permalink to this headline">¶</a></h2>
<p>The shared storage device must use the GUID Partition Table (GPT) disk
layout as defined in <a class="reference internal" href="references.html#uefi" id="id4">[UEFI]</a> § 5.3, unless the platform boot sequence is
fundamentally incompatible with the GPT disk layout.
In which case, a legacy Master Boot Recored (MBR) must be used.
<a class="footnote-reference" href="#mbrreqexample" id="id5">[4]</a></p>
<table class="docutils footnote" frame="void" id="mbrreqexample" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[4]</a></td><td>For example, if the SoC boot ROM requires an MBR to
find the next stage firmware image, then it is incompatible with
the GPT boot layout.
Similarly, if the boot ROM expects the next stage firmware to be located
at LBA1 (the location of the GPT Header), then it is incompatible with
the GPT disk layout.
In both cases the shared storage device must use legacy MBR partitioning.</td></tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>MBR partitioning is deprecated and only included for legacy support.
All new platforms are expected to use GPT partitioning.
GPT partitioning supports a much larger number of partitions, and
has built in resiliency.</p>
<p class="last">A future version of this specification will disallow the use of MBR
partitioning.</p>
</div>
<p>Firmware images and data in shared storage should be contained
in partitions described by the GPT or MBR.
The platform should locate firmware by searching the partition table for
the partition(s) containing firmware.</p>
<p>However, some SoCs load firmware from a fixed offset into the storage media.
In this case, to protect against partitioning tools overwriting firmware, the
partition table must be formed in a way to protect the firmware image(s) as
described in sections <a class="reference internal" href="#section-gpt-parts"><span class="std std-ref">GPT partitioning</span></a> and <a class="reference internal" href="#section-mbr-parts"><span class="std std-ref">MBR partitioning</span></a>.</p>
<p>Automatic partitioning tools (e.g. an OS installer) must not
delete the protective information in the partition table, or
delete, move, or modify protective partition entries.
Manual partitioning tools should provide warnings when modifying
protective partitions.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Fixed offsets to firmware data is supported only for legacy reasons.
All new platforms are expected to use partitions to locate firmware files.</p>
<p class="last">A future version of this specification will disallow the use of fixed
offsets.</p>
</div>
<div class="section" id="gpt-partitioning">
<span id="section-gpt-parts"></span><h3>4.1.1. GPT partitioning<a class="headerlink" href="#gpt-partitioning" title="Permalink to this headline">¶</a></h3>
<p>The partition table must strictly conform to the UEFI specification and include
a protective MBR authored exactly as described in <a class="reference internal" href="references.html#uefi" id="id6">[UEFI]</a> § 5.3 (hybrid
partitioning schemes are not permitted).</p>
<p>Fixed-location firmware images must be protected by creating protective
partition entries, or by placing GPT data structures away from the LBAs
occupied by firmware,</p>
<p>Protective partitions are entries in the partition table that cover the
LBA region occupied by firmware and have the ‘Required Partition’ attribute
set.
A protective partition must use a <cite>PartitionTypeGUID</cite> that identifies it
as a firmware protective partition. (e.g., don’t reuse a GUID used by
non-protective partitions).
There are no requirements on the contents or layout of the firmware
protective partition.</p>
<p>Placing GPT data structures away from firmware images can be accomplished by
adjusting the GUID Partition Entry array location
(adjusting the values of <cite>PartitionEntryLBA</cite> and <cite>NumberOfPartitionEntries</cite>,
and <cite>SizeOfPartitionEntry</cite>),
or by specifying the usable LBAs (Choosing <cite>FirstUsableLBA</cite>/<cite>LastUsableLBA</cite>
to not overlap the fixed firmware location).
See <a class="reference internal" href="references.html#uefi" id="id7">[UEFI]</a> § 5.3.2.</p>
<p>Given the choice, platforms should use protective partitions over
adjusting the placement of GPT data structures because protective partitions
provide explicit information about the protected region.</p>
<div class="section" id="mbr-partitioning">
<span id="section-mbr-parts"></span><h4>4.1.1.1. MBR partitioning<a class="headerlink" href="#mbr-partitioning" title="Permalink to this headline">¶</a></h4>
<p>If firmware is at a fixed location entirely within the first 1MiB of
storage (&lt;= LBA2047) then no protective partitions are required.
If firmware resides in a fixed location outside the first 1MiB,
then a protective partition must be used to cover the firmware LBAs.
Protective partitions should have a partition type of 0xF8 unless an
immutable feature of the platform makes this impossible.</p>
<p>OS partitioning tools must not create partitions in the first 1MiB
of the storage device, and must not remove protective partitions.</p>
</div>
</div>
</div>
<div class="section" id="firmware-partition-filesystem">
<span id="section-fw-partition-fs"></span><h2>4.2. Firmware Partition Filesystem<a class="headerlink" href="#firmware-partition-filesystem" title="Permalink to this headline">¶</a></h2>
<p>Where possible, firmware images and data should be stored in a filesystem.
Firmware can be stored either in a dedicated firmware partition,
or in certain circumstances in the UEFI System Partition (ESP).
Using a filesystem makes it simpler to manage multiple firmware files and
makes it possible for a single disk image to contain firmware for multiple
platforms.</p>
<p>When firmware is stored in the ESP, the ESP should contain a directory named
<code class="docutils literal notranslate"><span class="pre">/FIRMWARE</span></code> in the root directory,
and all firmware images and data should be stored in platform vendor
subdirectories under <code class="docutils literal notranslate"><span class="pre">/FIRMWARE</span></code>.</p>
<p>Dedicated firmware partitions should be formatted with a FAT
filesystem as defined by the UEFI specification.
Dedicated firmware partitions should use the same <code class="docutils literal notranslate"><span class="pre">/FIRMWARE</span></code> directory
hierarchy.
OS tools shall ignore dedicated firmware partitions,
and shall not attempt to use a dedicated firmware partition as an ESP.</p>
<p>Vendors may choose their own subdirectory name under <code class="docutils literal notranslate"><span class="pre">/FIRMWARE</span></code>,
but shall choose names that do not conflict with other vendors.
Normally the vendor name will be the name of the SoC vendor, because the
firmware directory name will be hard coded in the SoC’s boot ROM.
Vendors are recommended to use their Devicetree vendor prefix or ACPI
vendor ID as their vendor subdirectory name.</p>
<p>Vendors are free to decide how to structure subdirectories under their
own vendor directory, but they shall use a naming convention that allows
multiple SoCs to be supported in the same filesystem.</p>
<p>For example, a vendor named Acme with two SoCs, AM100 &amp; AM300, could
choose to use the SoC part number as a subdirectory in the firmware path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FIRMWARE</span>
  <span class="o">/</span><span class="n">ACME</span>
    <span class="o">/</span><span class="n">AM100</span>
      <span class="n">fw</span><span class="o">.</span><span class="n">img</span>
    <span class="o">/</span><span class="n">AM300</span>
      <span class="n">fw</span><span class="o">.</span><span class="n">img</span>
</pre></div>
</div>
<p>It is also recommended for dedicated firmware partitions to use the
<code class="docutils literal notranslate"><span class="pre">/FIRMWARE</span></code> file hierarchy.</p>
<p>The following is a sample directory structure for firmware files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">FIRMWARE</span>
  <span class="o">/&lt;</span><span class="n">Vendor</span> <span class="mi">1</span> <span class="n">Directory</span><span class="o">&gt;</span>
     <span class="o">/&lt;</span><span class="n">SoC</span> <span class="n">A</span> <span class="n">Directory</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">Firmware</span> <span class="n">image</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">Firmware</span> <span class="n">data</span><span class="o">&gt;</span>
     <span class="o">/&lt;</span><span class="n">SoC</span> <span class="n">B</span> <span class="n">Directory</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">Firmware</span> <span class="n">image</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">Firmware</span> <span class="n">data</span><span class="o">&gt;</span>
  <span class="o">/&lt;</span><span class="n">Vendor</span> <span class="mi">2</span> <span class="n">Directory</span><span class="o">&gt;</span>
     <span class="o">&lt;</span><span class="n">Common</span> <span class="n">Firmware</span> <span class="n">image</span><span class="o">&gt;</span>
     <span class="o">&lt;</span><span class="n">Common</span> <span class="n">Firmware</span> <span class="n">data</span><span class="o">&gt;</span>
  <span class="o">/&lt;</span><span class="n">Vendor</span> <span class="mi">3</span> <span class="n">Directory</span><span class="o">&gt;</span>
     <span class="o">/&lt;</span><span class="n">SoC</span> <span class="n">E</span> <span class="n">Directory</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">Firmware</span> <span class="n">image</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Operating systems and installers should not manipulate any files in the
<code class="docutils literal notranslate"><span class="pre">/FIRMWARE</span></code> hierarchy during normal operation.</p>
<p>The sections below discuss the requirements when using both fixed and
removable storage.
However, it should be noted that the recommended behaviour of firmware
should be identical regardless of storage type.
In both cases, the recommended boot sequence is to first search for firmware
in a dedicated firmware partition, and second search for firmware in the
ESP.
The only difference between fixed and removable storage is the recommended
factory settings for the platform.</p>
<div class="section" id="fixed-shared-storage">
<h3>4.2.1. Fixed Shared Storage<a class="headerlink" href="#fixed-shared-storage" title="Permalink to this headline">¶</a></h3>
<p>Fixed storage is storage that is permanently attached to the platform,
and cannot be moved between systems.
eMMC and Universal Flash Storage (UFS) device are often used as
shared fixed storage for both firmware and the OS.</p>
<p>Where possible, it is preferred for the system to boot from a dedicated boot
region on media that provides one (e.g., eMMC) that is sufficiently large.
Otherwise, the platform storage should be pre-formatted in the factory with
a partition table, a dedicated firmware partition, and firmware binaries
installed.</p>
<p>Operating systems must not use the dedicated firmware partition for installing
EFI applications including, but not limited to, the OS loader and OS specific
files. Instead, a normal ESP should be created.
OS partitioning tools must take care not to modify or delete dedicated
firmware partitions.</p>
</div>
<div class="section" id="removable-shared-storage">
<h3>4.2.2. Removable Shared Storage<a class="headerlink" href="#removable-shared-storage" title="Permalink to this headline">¶</a></h3>
<p>Removable storage is any media that can be physically removed from
the system and moved to another machine as part of normal operation
(e.g., SD cards, USB thumb drives, and CDs).</p>
<p>There are two primary scenarios for storing firmware on removable media.</p>
<ol class="arabic simple">
<li>Platforms that only have removable media (e.g., The Raspberry Pi has an
SD card slot, but no fixed storage).</li>
<li>Recovery when on-board firmware has been corrupted. If firmware on
fixed media has been corrupted, some platforms support loading firmware
from removable media which can then be used to recover the platform.</li>
</ol>
<p>In both cases, it is desirable to start with a stock OS boot image,
copy it to the media (SD or USB), and then add the necessary firmware files
to make the platform bootable.
Typically, OS boot images won’t include a dedicated firmware partition,
and it is inconvenient to repartition the media to add one.
It is simpler and easier for the user if they are able to copy
the required firmware files into the <code class="docutils literal notranslate"><span class="pre">/FIRMWARE</span></code> directory tree on the ESP
using the basic file manager tools provided by all desktop operating systems.</p>
<p>On removable media, firmware should be stored in the ESP under the
<code class="docutils literal notranslate"><span class="pre">/FIRMWARE</span></code> directory structure as described in
<a class="reference internal" href="#section-fw-partition-fs"><span class="std std-ref">Firmware Partition Filesystem</span></a>.
Platform vendors should support their platform by providing a single
.zip file that places all the required firmware files in the correct
locations when extracted in the ESP <code class="docutils literal notranslate"><span class="pre">/FIRMWARE</span></code> directory.
For simplicity sake, it is expected the same .zip file will recover the
firmware files in a dedicated firmware partition.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2017-2021 Arm Limited and Contributors.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.8</a>
      
      |
      <a href="_sources/chapter4-firmware-media.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>